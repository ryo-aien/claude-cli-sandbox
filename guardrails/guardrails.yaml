# Claude CLI ガードレール設定
# このファイルは Claude CLI エージェントが実行できるコマンドを制限します

rules:
  # 1. 破壊的なシェルコマンドをブロック
  - id: block-destructive-shell
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\s*rm\s+-rf\s+(/|\.|~)'
          - regex: '(^|;)\s*(?:mkfs|fdisk|parted)\b'
          - regex: '(^|;)\s*(?:shutdown|reboot|halt)\b'
    then:
      action: block
      message: "危険なコマンドがブロックされました。ルートディレクトリの削除、ディスク操作、システム停止コマンドは実行できません。"

  # 2. パーミッション変更のブロック
  - id: block-host-wide-permissions
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\s*chmod\s+.*\s+/(?:\s|$)'
          - regex: '(^|;)\s*chown\s+.*\s+/(?:\s|$)'
    then:
      action: block
      message: "ルートディレクトリに対するパーミッション変更はブロックされました。"

  # 3. パッケージマネージャの確認要求
  - id: require-confirmation-package-manager
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\s*apt(-get)?\s+install\b'
          - regex: '(^|;)\s*npm\s+(?:install|update|ci)\b'
    then:
      action: require_confirmation
      message: "パッケージのインストール/更新を実行しようとしています。続行しますか？"

  # 4. Git 履歴の保護
  - id: block-history-rewrite
    when:
      tool: shell
      command:
        any:
          - regex: 'git\s+push\s+.*--force'
          - regex: 'git\s+reset\s+--hard'
          - regex: 'git\s+clean\s+-fd'
    then:
      action: block
      message: "Git 履歴を変更するコマンドがブロックされました。強制プッシュ、ハードリセット、強制削除は実行できません。"

  # 5. ファイル編集の制限 - workspace外への編集をブロック
  - id: block-apply-patch-outside-workspace
    when:
      tool: apply_patch
      target_path:
        not_starts_with: /workspace
    then:
      action: block
      message: "/workspace 以外のディレクトリへのファイル編集はブロックされました。"

  # 6. バイナリファイルの編集をブロック
  - id: block-binary-file-edit
    when:
      tool: apply_patch
      target_path:
        regex: '\.(png|jpg|jpeg|gif|pdf|zip|tar|gz|bz2|xz|exe|bin|so|dylib|dll)$'
    then:
      action: block
      message: "バイナリファイルの編集はブロックされました。"

  # 7. 環境変数の削除や上書きを制限
  - id: block-env-modifications
    when:
      tool: shell
      command:
        regex: '(^|;)\s*(?:unset|export)\s+(?:PATH|HOME|USER)\b'
    then:
      action: require_confirmation
      message: "重要な環境変数を変更しようとしています。続行しますか？"

  # 8. ネットワーク関連の危険なコマンドをブロック
  - id: block-dangerous-network-commands
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\s*(?:iptables|ufw|firewall-cmd)\b'
          - regex: '(^|;)\s*nc\s+.*-[el]'
    then:
      action: block
      message: "ファイアウォール設定やリスナーの起動はブロックされました。"

# デフォルト動作
defaults:
  decision: allow
  message: "コマンドが許可されました。"

# 説明
description: |
  Claude CLI Sandbox 用のガードレール設定

  このガードレールは以下を保護します:
  - システムの破壊的操作の防止
  - ファイルシステムの保護
  - Git 履歴の保護
  - パッケージインストールの制御
  - ネットワーク設定の保護

  ルールにマッチしないコマンドは自動的に許可されます（ブラックリスト方式）。
